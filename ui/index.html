<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>STEP – Step 1 Preflight</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #topbar { display:flex; gap:12px; align-items:center; padding:10px 12px; border-bottom:1px solid #ddd; min-width:0; }
    #status { font-size: 13px; color:#444; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:40vw; }
    .btn { padding:6px 10px; border:1px solid #bbb; border-radius:8px; background:#fff; cursor:pointer; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    .muted { color:#666; font-size:12px; }
    #preflightInfo { margin-left:auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:45vw; }

    #warning { display:none; padding:8px 10px; background:#fff3cd; border:1px solid #ffeeba; color:#856404; font-size:13px; border-radius:6px; margin:8px; }
    #progress {
      display:none;
      padding:8px 12px;
      border-bottom:1px solid #eee;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;
      max-height:160px;
      overflow:auto;
      white-space: pre-wrap;
    }
    #previewViews { display:none; gap:12px; padding:12px; flex-wrap:wrap; align-items:flex-start; }
    .pvCard { display:flex; flex-direction:column; gap:6px; }
    .pvHdr { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .pvTitle { font-size:12px; color:#666; }
    img.pv { width:240px; border:2px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; user-select:none; }
    img.pv.selected { border-color:#2f6fed; box-shadow:0 0 0 2px rgba(47,111,237,0.15); }

    #orientRow { flex-basis:100%; display:flex; gap:10px; align-items:center; margin-top:4px; flex-wrap:wrap; }
    #selTop { font-weight:600; }
    .nodebtn { background:none; border:none; padding:2px 4px; text-align:left; width:100%; cursor:pointer; border-radius:6px; }
    .nodebtn:hover { background:#f3f3f3; }
    .nodebtn.selected { background:#e9e9e9; }

  </style>
</head>
<body>
  <div id="topbar">
    <input id="file" type="file" accept=".step,.stp"/>
    <button id="go" class="btn">Upload + Preview</button>
    <span id="status">No model loaded.</span>
    <span id="preflightInfo" class="muted"></span>
  </div>

  <div id="warning"></div>
  <div id="progress"></div>

  <div id="previewViews">
    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">TOP</div>
        <button id="btnTop" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_top" class="pv" title="Click to set as TOP" />
    </div>

    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">BOTTOM</div>
        <button id="btnBottom" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_bottom" class="pv" title="Click to set as TOP" />
    </div>

    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">FRONT</div>
        <button id="btnFront" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_front" class="pv" title="Click to set as TOP" />
    </div>

    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">BACK</div>
        <button id="btnBack" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_back" class="pv" title="Click to set as TOP" />
    </div>

    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">LEFT</div>
        <button id="btnLeft" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_left" class="pv" title="Click to set as TOP" />
    </div>

    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">RIGHT</div>
        <button id="btnRight" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_right" class="pv" title="Click to set as TOP" />
    </div>

    <div id="orientRow">
      <div class="muted">Selected TOP: <span id="selTop">—</span></div>
      <div class="muted">Rotate TOP:</div>
      <select id="rotSel" class="btn" style="font-size:12px;">
        <option value="0">0°</option>
        <option value="90">90°</option>
        <option value="180">180°</option>
        <option value="270">270°</option>
      </select>
      <button id="applyOrient" class="btn" style="font-size:12px;">Save rotation</button>
      <div class="muted">Pick the true TOP source, then rotate if needed.</div>
    </div>
  </div>

  <!-- Occurrence tree + STL viewer -->
  <div id="treeSection" style="display:none; border-top:1px solid #ddd;">
    <div style="display:flex; height: calc(100vh - 42px);">
      <div id="treePane" style="flex:0 0 360px; min-width:360px; border-right:1px solid #ddd; overflow:auto; padding:10px 12px;">
        <div class="pvHdr" style="margin-bottom:8px;">
          <div class="muted" id="treeTitle">Assembly (Grouped)</div>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button id="viewAssembly" class="btn" style="padding:4px 8px; font-size:12px;">Assembly (Grouped)</button>
            <button id="viewBom" class="btn" style="padding:4px 8px; font-size:12px;">BOM (Global)</button>
          </div>
        </div>

        <div class="muted" style="margin-bottom:8px;" id="treeHint">
          Click a row to load STL
        </div>

        <div id="tree"></div>

      </div>

      <div style="flex:1; display:flex; flex-direction:column;">
        <div id="viewer" style="flex:1; min-height:0; overflow:hidden;"></div>
        <div id="nodeMeta" style="border-top:1px solid #ddd; padding:10px 12px; height:160px; overflow:auto; white-space:pre; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;">
{ }
        </div>
      </div>
    </div>
  </div>


  <script type="module" src="/ui/app.js"></script>
</body>
</html>
