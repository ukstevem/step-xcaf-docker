<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>STEP – Step 1 Preflight</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #topbar { display:flex; gap:12px; align-items:center; padding:10px 12px; border-bottom:1px solid #ddd; min-width:0; }
    #status { font-size: 13px; color:#444; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:40vw; }
    .btn { padding:6px 10px; border:1px solid #bbb; border-radius:8px; background:#fff; cursor:pointer; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    .muted { color:#666; font-size:12px; }
    #preflightInfo { margin-left:auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:45vw; }

    #warning { display:none; padding:8px 10px; background:#fff3cd; border:1px solid #ffeeba; color:#856404; font-size:13px; border-radius:6px; margin:8px; }
    #progress {
      display:none;
      padding:8px 12px;
      border-bottom:1px solid #eee;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;
      max-height:160px;
      overflow:auto;
      white-space: pre-wrap;
    }
    #previewViews { display:none; gap:12px; padding:12px; flex-wrap:wrap; align-items:flex-start; }
    .pvCard { display:flex; flex-direction:column; gap:6px; }
    .pvHdr { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .pvTitle { font-size:12px; color:#666; }
    img.pv { width:240px; border:2px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; user-select:none; }
    img.pv.selected { border-color:#2f6fed; box-shadow:0 0 0 2px rgba(47,111,237,0.15); }

    #orientRow { flex-basis:100%; display:flex; gap:10px; align-items:center; margin-top:4px; flex-wrap:wrap; }
    #selTop { font-weight:600; }
    .nodebtn { background:none; border:none; padding:2px 4px; text-align:left; width:100%; cursor:pointer; border-radius:6px; }
    .nodebtn:hover { background:#f3f3f3; }
    .nodebtn.selected { background:#e9e9e9; }

    td.where-used { white-space: normal; }
    td.where-used .wu-line { line-height: 1.15; }
    td.where-used .wu-note { opacity: 0.7; font-style: italic; margin-top: 2px; }

    #treeSectionWrap { display:flex; height: calc(100vh - 42px); }

    #treePane {
      flex: 1 1 auto;
      min-width: 560px;
      border-right: 1px solid #ddd;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 10px 12px;
    }

    #tableWrap {
      flex: 1;
      min-height: 0;
      overflow: auto;
      border: 1px solid #eee;
      border-radius: 10px;
      background: #fff;
    }

    table.bom {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    table.bom thead th {
      position: sticky;
      top: 0;
      background: #f7f7f7;
      border-bottom: 1px solid #e5e5e5;
      padding: 6px 8px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
    }

    table.bom tbody td {
      border-bottom: 1px solid #f0f0f0;
      padding: 6px 8px;
      vertical-align: middle;
      white-space: nowrap;
    }

    table.bom tbody tr:hover { background: #f7fbff; }
    table.bom tbody tr.selected { background: #e9f2ff; }

    .cell-mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .cell-muted { color: #666; }
    .cell-right { text-align: right; }

    #bomSearch {
      width: 180px;
      padding: 5px 8px;
      border: 1px solid #cfcfcf;
      border-radius: 8px;
      font-size: 12px;
    }

    /* --- make viewer less prominent --- */
    #rightPane {
      flex: 0 0 420px;  /* smaller fixed column */
      display: flex;
      flex-direction: column;
      min-width: 420px;
    }

    #viewer {
      flex: 0 0 320px;  /* fixed height viewer */
      min-height: 320px;
      border-bottom: 1px solid #ddd;
    }

    #nodeMeta {
      flex: 1 1 auto;   /* meta takes remaining height */
      height: auto !important;
      min-height: 0;
      overflow: auto;
    }

    .lnk {
      display: inline-block;
      padding: 2px 6px;
      border: 1px solid #cfd6e4;
      border-radius: 999px;
      font-size: 11px;
      text-decoration: none;
      color: #1f4fbf;
      background: #f6f8ff;
      line-height: 1.4;
    }
    .lnk:hover { background: #eef3ff; }
    .lnk.missing {
      color: #888;
      border-color: #e3e3e3;
      background: #fafafa;
      cursor: default;
      pointer-events: none;
    }

    /* keep link columns narrow */
    .cell-link { width: 1%; } /* lets the browser shrink these */
  </style>
</head>
<body>
  <div id="topbar">
    <input id="file" type="file" accept=".step,.stp"/>
    <button id="go" class="btn">Upload + Preview</button>
    <span id="status">No model loaded.</span>
    <span id="preflightInfo" class="muted"></span>
  </div>

  <div id="warning"></div>
  <div id="progress"></div>

  <div id="previewViews">
    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">TOP</div>
        <button id="btnTop" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_top" class="pv" title="Click to set as TOP" />
    </div>

    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">BOTTOM</div>
        <button id="btnBottom" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_bottom" class="pv" title="Click to set as TOP" />
    </div>

    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">FRONT</div>
        <button id="btnFront" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_front" class="pv" title="Click to set as TOP" />
    </div>

    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">BACK</div>
        <button id="btnBack" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_back" class="pv" title="Click to set as TOP" />
    </div>

    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">LEFT</div>
        <button id="btnLeft" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_left" class="pv" title="Click to set as TOP" />
    </div>

    <div class="pvCard">
      <div class="pvHdr">
        <div class="pvTitle">RIGHT</div>
        <button id="btnRight" class="btn" style="padding:4px 8px; font-size:12px;">Use as TOP</button>
      </div>
      <img id="pv_right" class="pv" title="Click to set as TOP" />
    </div>

    <div id="orientRow">
      <div class="muted">Selected TOP: <span id="selTop">—</span></div>
      <div class="muted">Rotate TOP:</div>
      <select id="rotSel" class="btn" style="font-size:12px;">
        <option value="0">0°</option>
        <option value="90">90°</option>
        <option value="180">180°</option>
        <option value="270">270°</option>
      </select>
      <button id="applyOrient" class="btn" style="font-size:12px;">Save rotation</button>
      <div class="muted">Pick the true TOP source, then rotate if needed.</div>
    </div>
  </div>

  <div id="treeSection" style="display:none; border-top:1px solid #ddd;">
    <div id="treeSectionWrap">
      <div id="treePane">
        <div class="pvHdr" style="margin-bottom:8px;">
          <div class="muted" id="treeTitle">Assembly (Grouped)</div>

          <input id="bomSearch" placeholder="Filter…" style="display:none;" />

          <div style="display:flex; gap:8px; margin-left:auto;">
            <button id="viewDash" class="btn" style="padding:4px 8px; font-size:12px;">Dashboard</button>
            <button id="viewAssembly" class="btn" style="padding:4px 8px; font-size:12px;">Assembly (Grouped)</button>
            <button id="viewBom" class="btn" style="padding:4px 8px; font-size:12px;">BOM (Global)</button>
            <button id="btnBomViewer" class="btn btn-sm">Viewer/Explosion BOM</button>
            <button id="btnBomPurchasing" class="btn btn-sm">Purchasing BOM</button>
          </div>
        </div>

        <div class="muted" style="margin-bottom:8px;" id="treeHint">
          Click a row to load STL
        </div>

        <div id="tableWrap">
          <!-- Dashboard cards live here (hidden unless Dashboard view) -->
          <div id="dash" style="display:none;"></div>

          <!-- Tree / BOM table lives here -->
          <div id="tree"></div>
        </div>
      </div>

      <div id="rightPane">
        <div id="viewer"></div>
        <div id="nodeMeta" style="padding:10px 12px; white-space:pre; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;">
{ }
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="/ui/app.js"></script>
</body>
</html>
